(function() {
    const fileId = '{{fileId}}';
    const currentFileName = window.location.pathname.split('/').pop() || 'index.html';
    console.log('üî• Hot Reloader activated for file:', fileId, 'fileName:', currentFileName, 'on port {{webSocketPort}}');

    let ws;
    let reconnectAttempts = 0;
    const maxReconnectAttempts = {{maxReconnectAttempts}};
    let isReloading = false;

    // –ó–±–µ—Ä—ñ–≥–∞—î–º–æ —ñ–Ω—Ñ–æ—Ä–º–∞—Ü—ñ—é –ø—Ä–æ WebSocket –≤ –≥–ª–æ–±–∞–ª—å–Ω—ñ–π –æ–±–ª–∞—Å—Ç—ñ –¥–ª—è –∫–æ–∂–Ω–æ–≥–æ —Ñ–∞–π–ª—É –æ–∫—Ä–µ–º–æ
    if (!window.hotReloaderInstances) {
        window.hotReloaderInstances = {};
    }

    // –ü–µ—Ä–µ–≤—ñ—Ä—è—î–º–æ —á–∏ –≤–∂–µ —ñ—Å–Ω—É—î –∞–∫—Ç–∏–≤–Ω–µ –∑'—î–¥–Ω–∞–Ω–Ω—è –¥–ª—è —Ü—å–æ–≥–æ —Ñ–∞–π–ª—É
    if (window.hotReloaderInstances[fileId]) {
        console.log('üîÑ Hot Reloader: Closing previous connection for file:', fileId);
        try {
            window.hotReloaderInstances[fileId].close();
        } catch (e) {
            console.debug('Hot Reloader: Error closing previous connection:', e);
        }
    }

    // –§—É–Ω–∫—Ü—ñ—è –¥–ª—è hot reload CSS —Ñ–∞–π–ª—ñ–≤
    function reloadCSS(cssFileName) {
        console.log('üé® Hot Reloader: Reloading CSS:', cssFileName || 'all stylesheets');

        const links = document.querySelectorAll('link[rel="stylesheet"]');
        let reloadedCount = 0;

        links.forEach(link => {
            const href = link.getAttribute('href');
            if (!href) return;

            // –Ø–∫—â–æ –≤–∫–∞–∑–∞–Ω–æ –∫–æ–Ω–∫—Ä–µ—Ç–Ω–∏–π —Ñ–∞–π–ª, –ø–µ—Ä–µ–≤—ñ—Ä—è—î–º–æ –≤—ñ–¥–ø–æ–≤—ñ–¥–Ω—ñ—Å—Ç—å
            if (cssFileName && !href.includes(cssFileName)) {
                return;
            }

            // –°—Ç–≤–æ—Ä—é—î–º–æ –Ω–æ–≤–∏–π link –µ–ª–µ–º–µ–Ω—Ç
            const newLink = document.createElement('link');
            newLink.rel = 'stylesheet';
            newLink.type = 'text/css';

            // –î–æ–¥–∞—î–º–æ timestamp –¥–ª—è –æ–±—Ö–æ–¥—É –∫–µ—à—É
            const separator = href.includes('?') ? '&' : '?';
            newLink.href = href + separator + '_hotreload=' + Date.now();

            // –í—Å—Ç–∞–≤–ª—è—î–º–æ –Ω–æ–≤–∏–π link –ø—ñ—Å–ª—è —Å—Ç–∞—Ä–æ–≥–æ
            link.parentNode.insertBefore(newLink, link.nextSibling);

            // –í–∏–¥–∞–ª—è—î–º–æ —Å—Ç–∞—Ä–∏–π link –ø—ñ—Å–ª—è –∑–∞–≤–∞–Ω—Ç–∞–∂–µ–Ω–Ω—è –Ω–æ–≤–æ–≥–æ
            newLink.onload = function() {
                if (link.parentNode) {
                    link.parentNode.removeChild(link);
                }
            };

            // –ù–∞ –≤—Å—è–∫–∏–π –≤–∏–ø–∞–¥–æ–∫ –≤–∏–¥–∞–ª—è—î–º–æ —á–µ—Ä–µ–∑ —Ç–∞–π–º–∞—É—Ç
            setTimeout(() => {
                if (link.parentNode) {
                    link.parentNode.removeChild(link);
                }
            }, 200);

            reloadedCount++;
        });

        // –Ø–∫—â–æ –Ω–µ –∑–Ω–∞–π—à–ª–∏ CSS —Ñ–∞–π–ª—ñ–≤, –º–æ–∂–ª–∏–≤–æ —Ü–µ inline —Å—Ç–∏–ª—ñ –∞–±–æ @import
        if (reloadedCount === 0 && !cssFileName) {
            // –ü—Ä–æ–±—É—î–º–æ –æ–Ω–æ–≤–∏—Ç–∏ –≤—Å—é —Å—Ç–æ—Ä—ñ–Ω–∫—É —è–∫ fallback
            console.log('üîÑ Hot Reloader: No CSS links found, falling back to full reload');
            location.reload();
        } else {
            console.log(`‚úÖ Hot Reloader: Reloaded ${reloadedCount} CSS file(s)`);
            showReloadIndicator('css');
        }
    }

    // –§—É–Ω–∫—Ü—ñ—è –¥–ª—è hot reload JS —Ñ–∞–π–ª—ñ–≤ (—Å–∫–ª–∞–¥–Ω—ñ—à–µ, —Ç–æ–º—É –ø–æ–∫–∏ fallback –¥–æ reload)
    function reloadJS(jsFileName) {
        console.log('üìú Hot Reloader: JS file changed:', jsFileName);
        console.log('üîÑ Hot Reloader: JS hot reload not implemented, doing full reload');
        showReloadIndicator('js');

        // –ü–ª–∞–≤–Ω–∏–π –µ—Ñ–µ–∫—Ç –ø–µ—Ä–µ–¥ –æ–Ω–æ–≤–ª–µ–Ω–Ω—è–º
        if (document.body) {
            document.body.style.transition = 'opacity 0.2s';
            document.body.style.opacity = '0.8';
        }

        setTimeout(() => {
            location.reload();
        }, 200);
    }

    // –§—É–Ω–∫—Ü—ñ—è –¥–ª—è –ø–æ–∫–∞–∑—É —ñ–Ω–¥–∏–∫–∞—Ç–æ—Ä–∞ –æ–Ω–æ–≤–ª–µ–Ω–Ω—è
    function showReloadIndicator(type) {
        // –°—Ç–≤–æ—Ä—é—î–º–æ —Ç–∏–º—á–∞—Å–æ–≤–∏–π —ñ–Ω–¥–∏–∫–∞—Ç–æ—Ä
        const reloadIndicator = document.createElement('div');
        const emoji = type === 'css' ? 'üé®' : type === 'js' ? 'üìú' : 'üîÑ';
        const text = type === 'css' ? 'CSS Updated' : type === 'js' ? 'JS Updated' : 'Reloaded';

        reloadIndicator.innerHTML = `${emoji} ${text}`;
        reloadIndicator.style.cssText =
            'position: fixed;' +
            'top: 20px;' +
            'right: 20px;' +
            'background: #4CAF50;' +
            'color: white;' +
            'padding: 8px 16px;' +
            'border-radius: 20px;' +
            'font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", system-ui, sans-serif;' +
            'font-size: 14px;' +
            'font-weight: 500;' +
            'z-index: 2147483647;' +
            'box-shadow: 0 4px 12px rgba(0,0,0,0.15);' +
            'animation: hotReloadSlideIn 0.3s ease-out;' +
            'pointer-events: none;';

        // –î–æ–¥–∞—î–º–æ CSS –∞–Ω—ñ–º–∞—Ü—ñ—é —è–∫—â–æ —ó—ó —â–µ –Ω–µ–º–∞—î
        if (!document.getElementById('hotReloadStyles')) {
            const style = document.createElement('style');
            style.id = 'hotReloadStyles';
            style.textContent = `
                @keyframes hotReloadSlideIn {
                    from { transform: translateX(100%); opacity: 0; }
                    to { transform: translateX(0); opacity: 1; }
                }
                @keyframes hotReloadSlideOut {
                    from { transform: translateX(0); opacity: 1; }
                    to { transform: translateX(100%); opacity: 0; }
                }
            `;
            document.head.appendChild(style);
        }

        document.body.appendChild(reloadIndicator);

        // –í–∏–¥–∞–ª—è—î–º–æ —ñ–Ω–¥–∏–∫–∞—Ç–æ—Ä —á–µ—Ä–µ–∑ 2 —Å–µ–∫—É–Ω–¥–∏
        setTimeout(() => {
            reloadIndicator.style.animation = 'hotReloadSlideOut 0.3s ease-in';
            setTimeout(() => {
                if (reloadIndicator.parentNode) {
                    reloadIndicator.parentNode.removeChild(reloadIndicator);
                }
            }, 300);
        }, 2000);
    }

    // –§—É–Ω–∫—Ü—ñ—è –¥–ª—è –ø–µ—Ä–µ–≤—ñ—Ä–∫–∏ —á–∏ –ø–æ–≤—ñ–¥–æ–º–ª–µ–Ω–Ω—è —Å—Ç–æ—Å—É—î—Ç—å—Å—è –ø–æ—Ç–æ—á–Ω–æ–≥–æ —Ñ–∞–π–ª—É
    function isRelevantFileChange(changedFileName) {
        if (!changedFileName) return true; // —è–∫—â–æ –Ω–µ –≤–∫–∞–∑–∞–Ω–æ —Ñ–∞–π–ª - –ø–µ—Ä–µ–∑–∞–≤–∞–Ω—Ç–∞–∂—É—î–º–æ –≤—Å–µ

        const changedFileNameLower = changedFileName.toLowerCase();
        const currentFileNameLower = currentFileName.toLowerCase();

        // –ü–µ—Ä–µ–∑–∞–≤–∞–Ω—Ç–∞–∂—É—î–º–æ —è–∫—â–æ:
        // 1. –ó–º—ñ–Ω–∏–≤—Å—è –ø–æ—Ç–æ—á–Ω–∏–π HTML —Ñ–∞–π–ª
        // 2. –ó–º—ñ–Ω–∏–≤—Å—è CSS —Ñ–∞–π–ª (–º–æ–∂–µ –≤–ø–ª–∏–≤–∞—Ç–∏ –Ω–∞ –≤–∏–≥–ª—è–¥)
        // 3. –ó–º—ñ–Ω–∏–≤—Å—è JS —Ñ–∞–π–ª (–º–æ–∂–µ –≤–ø–ª–∏–≤–∞—Ç–∏ –Ω–∞ –ª–æ–≥—ñ–∫—É)
        // 4. –ó–º—ñ–Ω–∏–ª–∏—Å—å —ñ–Ω—à—ñ —Ä–µ—Å—É—Ä—Å–∏ —è–∫—ñ –∑–∞–∑–≤–∏—á–∞–π –≤–∏–∫–æ—Ä–∏—Å—Ç–æ–≤—É—é—Ç—å HTML —Ñ–∞–π–ª–∏

        return (
            changedFileNameLower === currentFileNameLower || // —Ç–æ—á–Ω–∞ –≤—ñ–¥–ø–æ–≤—ñ–¥–Ω—ñ—Å—Ç—å —Ñ–∞–π–ª—É
            changedFileNameLower.endsWith('.css') ||         // –≤—Å—ñ CSS —Ñ–∞–π–ª–∏
            changedFileNameLower.endsWith('.js') ||          // –≤—Å—ñ JS —Ñ–∞–π–ª–∏
            changedFileNameLower.endsWith('.html') ||        // –≤—Å—ñ HTML —Ñ–∞–π–ª–∏ (—è–∫—â–æ –≤–∫–ª—é—á–∞—é—Ç—å –æ–¥–∏–Ω –æ–¥–Ω–æ–≥–æ)
            changedFileNameLower.endsWith('.json') ||        // –∫–æ–Ω—Ñ—ñ–≥—É—Ä–∞—Ü—ñ–π–Ω—ñ —Ñ–∞–π–ª–∏
            changedFileNameLower.includes('style') ||        // —Ñ–∞–π–ª–∏ –∑—ñ —Å—Ç–∏–ª—è–º–∏
            changedFileNameLower.includes('script')          // —Ñ–∞–π–ª–∏ –∑—ñ —Å–∫—Ä–∏–ø—Ç–∞–º–∏
        );
    }

    function connectWebSocket() {
        if (isReloading) return;

        try {
            ws = new WebSocket('ws://localhost:{{webSocketPort}}');

            // –ó–±–µ—Ä—ñ–≥–∞—î–º–æ –ø–æ—Å–∏–ª–∞–Ω–Ω—è –Ω–∞ WebSocket –¥–ª—è —Ü—å–æ–≥–æ —Ñ–∞–π–ª—É
            window.hotReloaderInstances[fileId] = ws;

            ws.onopen = function(event) {
                console.log('üîó Hot Reloader: WebSocket Connected for file:', fileId);
                reconnectAttempts = 0;
                updateIndicator('connected');
            };

            ws.onmessage = function(event) {
                try {
                    const data = JSON.parse(event.data);
                    const changedFileName = data.file;

                    // –ü–µ—Ä–µ–≤—ñ—Ä—è—î–º–æ —á–∏ —Ü–µ –ø–æ–≤—ñ–¥–æ–º–ª–µ–Ω–Ω—è —Å—Ç–æ—Å—É—î—Ç—å—Å—è –Ω–∞—à–æ–≥–æ —Ñ–∞–π–ª—É
                    if (!isRelevantFileChange(changedFileName)) {
                        console.log('üîÑ Hot Reloader: Ignoring irrelevant file change for', fileId + ':', changedFileName);
                        return;
                    }

                    switch (data.type) {
                        case 'css-reload':
                            console.log('üé® Hot Reloader: CSS file changed for', fileId + ':', changedFileName);
                            reloadCSS(changedFileName);
                            break;

                        case 'js-reload':
                            console.log('üìú Hot Reloader: JS file changed for', fileId + ':', changedFileName);
                            reloadJS(changedFileName);
                            break;

                        case 'reload':
                        default:
                            isReloading = true;
                            console.log('üîÑ Hot Reloader: File changed for', fileId + ':', changedFileName || 'Unknown');

                            // –ü–ª–∞–≤–Ω–∏–π –µ—Ñ–µ–∫—Ç –ø–µ—Ä–µ–¥ –æ–Ω–æ–≤–ª–µ–Ω–Ω—è–º
                            if (document.body) {
                                document.body.style.transition = 'opacity 0.2s';
                                document.body.style.opacity = '0.8';
                            }

                            setTimeout(() => {
                                location.reload();
                            }, 200);
                            break;
                    }
                } catch (error) {
                    console.error('‚ùå Hot Reloader: Message parse error:', error);
                }
            };

            ws.onclose = function(event) {
                // –í–∏–¥–∞–ª—è—î–º–æ –∑ —Ä–µ—î—Å—Ç—Ä—É –ø—Ä–∏ –∑–∞–∫—Ä–∏—Ç—Ç—ñ
                if (window.hotReloaderInstances[fileId] === ws) {
                    delete window.hotReloaderInstances[fileId];
                }

                if (!isReloading) {
                    console.log('üîå Hot Reloader: WebSocket Disconnected for file:', fileId, 'code:', event.code);
                    updateIndicator('disconnected');

                    if (maxReconnectAttempts > 0) {
                        if (reconnectAttempts < maxReconnectAttempts) {
                            reconnectAttempts++;
                            const delay = Math.min(5000, 1000 * reconnectAttempts);
                            console.log('üîÑ Hot Reloader: Reconnecting for', fileId, reconnectAttempts + '/' + maxReconnectAttempts + ' in ' + delay + 'ms');
                            setTimeout(connectWebSocket, delay);
                        } else {
                            console.error('‚ùå Hot Reloader: Failed to reconnect for', fileId, 'after', maxReconnectAttempts, 'attempts');
                            updateIndicator('failed');
                        }
                    } else {
                        const delay = Math.min(5000, 1000 * reconnectAttempts);
                        setTimeout(connectWebSocket, delay);
                    }
                }
            };

            ws.onerror = function(error) {
                console.error('‚ùå Hot Reloader: WebSocket Error for file', fileId + ':', error);
                updateIndicator('error');
            };

        } catch (error) {
            console.error('‚ùå Hot Reloader: Failed to create WebSocket for file', fileId + ':', error);
            updateIndicator('error');

            if (reconnectAttempts < maxReconnectAttempts) {
                reconnectAttempts++;
                setTimeout(connectWebSocket, 2000);
            }
        }
    }

    let indicator;

    function createIndicator() {
        indicator = document.createElement('div');
        indicator.innerHTML = 'üî•';
        indicator.style.cssText =
            'position: fixed;' +
            '{{positionStyles}}' +
            'background: #4CAF50;' +
            'color: white;' +
            'width: 24px;' +
            'height: 24px;' +
            'display: flex;' +
            'align-items: center;' +
            'justify-content: center;' +
            'border-radius: 50%;' +
            'font-family: monospace;' +
            'font-size: 12px;' +
            'z-index: 2147483647;' +
            'box-shadow: 0 2px 4px rgba(0,0,0,0.2);' +
            'transition: all 0.3s ease;' +
            'cursor: pointer;';

        indicator.addEventListener('click', function() {
            console.log('üî• Hot Reloader status for', currentFileName + ':', {
                fileId: fileId,
                fileName: currentFileName,
                connected: ws && ws.readyState === WebSocket.OPEN,
                readyState: ws ? ws.readyState : 'not created',
                reconnectAttempts: reconnectAttempts,
                port: {{webSocketPort}},
                activeInstances: Object.keys(window.hotReloaderInstances || {}).length
            });
        });

        return indicator;
    }

    function updateIndicator(status) {
        if (!indicator) return;

        switch (status) {
            case 'connected':
                indicator.style.background = '#4CAF50';
                indicator.innerHTML = 'üî•';
                indicator.title = 'Hot Reloader connected for ' + currentFileName + ' (click for status)';
                break;
            case 'disconnected':
                indicator.style.background = '#FF9800';
                indicator.innerHTML = 'üîÑ';
                indicator.title = 'Hot Reloader reconnecting for ' + currentFileName;
                break;
            case 'error':
            case 'failed':
                indicator.style.background = '#F44336';
                indicator.innerHTML = '‚ùå';
                indicator.title = 'Hot Reloader connection error for ' + currentFileName;
                break;
        }
    }

    function showIndicator() {
        if (!document.body) return;

        indicator = createIndicator();
        document.body.appendChild(indicator);

        // –ü—Ä–∏—Ö–æ–≤—É—î–º–æ —ñ–Ω–¥–∏–∫–∞—Ç–æ—Ä —á–µ—Ä–µ–∑ 5 —Å–µ–∫—É–Ω–¥
        setTimeout(function() {
            if (indicator && ws && ws.readyState === WebSocket.OPEN) {
                indicator.style.opacity = '0.7';
                setTimeout(function() {
                    if (indicator && indicator.parentNode) {
                        indicator.style.opacity = '0.3';
                    }
                }, 2000);
            }
        }, 5000);
    }

    function initialize() {
        showIndicator();
        connectWebSocket();
    }

    // –ó–∞–ø—É—Å–∫–∞—î–º–æ –ø—ñ—Å–ª—è –∑–∞–≤–∞–Ω—Ç–∞–∂–µ–Ω–Ω—è DOM
    if (document.readyState === 'loading') {
        document.addEventListener('DOMContentLoaded', initialize);
    } else {
        initialize();
    }

    // –û—á–∏—â—É—î–º–æ —Ä–µ—Å—É—Ä—Å–∏ –ø—Ä–∏ –∑–∞–∫—Ä–∏—Ç—Ç—ñ
    window.addEventListener('beforeunload', function() {
        if (ws && window.hotReloaderInstances[fileId] === ws) {
            ws.close();
            delete window.hotReloaderInstances[fileId];
        }
    });

    // –û—á–∏—â—É—î–º–æ –ø—Ä–∏ –ø–µ—Ä–µ—Ö–æ–¥—ñ –Ω–∞ —ñ–Ω—à—É —Å—Ç–æ—Ä—ñ–Ω–∫—É
    window.addEventListener('pagehide', function() {
        if (ws && window.hotReloaderInstances[fileId] === ws) {
            ws.close();
            delete window.hotReloaderInstances[fileId];
        }
    });
})();